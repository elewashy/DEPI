{% extends "base.html" %}

{% block title %}Orders Dashboard - Market Flow{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="h2 mb-1">Orders Dashboard</h1>
            <p class="text-muted">Manage and analyze your order data</p>
        </div>
        <div>
            {% if pagination and pagination.total %}
                <span class="badge bg-primary">{{ "{:,}".format(pagination.total) }} Total Orders</span>
            {% endif %}
        </div>
    </div>
</div>

<!-- Filters -->
<div class="filter-card">
    <form method="GET" id="filterForm">
        <div class="row g-3 align-items-end">
            <div class="col-lg-3 col-md-4">
                <label for="search" class="form-label">Search</label>
                <input type="text" class="form-control form-control-sm" id="search" name="search" 
                       placeholder="Customer or Product..." value="{{ filters.search or '' }}">
            </div>
            <div class="col-lg-2 col-md-3">
                <label for="branch" class="form-label">Branch</label>
                <select class="form-select form-select-sm" id="branch" name="branch">
                    <option value="">All Branches</option>
                    {% for branch in branches %}
                        <option value="{{ branch }}" {{ 'selected' if filters.branch == branch }}>{{ branch }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-lg-2 col-md-3">
                <label for="date_from" class="form-label">From</label>
                <input type="date" class="form-control form-control-sm" id="date_from" name="date_from" 
                       value="{{ filters.date_from or '' }}" style="position: relative; z-index: 1;">
            </div>
            <div class="col-lg-2 col-md-3">
                <label for="date_to" class="form-label">To</label>
                <input type="date" class="form-control form-control-sm" id="date_to" name="date_to" 
                       value="{{ filters.date_to or '' }}" style="position: relative; z-index: 1;">
            </div>
            <div class="col-lg-1 col-md-2">
                <label for="per_page" class="form-label">Show</label>
                <select class="form-select form-select-sm" id="per_page" name="per_page">
                    <option value="25" {{ 'selected' if request.args.get('per_page', '50') == '25' }}>25</option>
                    <option value="50" {{ 'selected' if request.args.get('per_page', '50') == '50' }}>50</option>
                    <option value="100" {{ 'selected' if request.args.get('per_page', '50') == '100' }}>100</option>
                </select>
            </div>
            <div class="col-lg-2 col-md-3">
                <div class="d-flex gap-1">
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="fas fa-search"></i>
                    </button>
                    <a href="{{ url_for('orders_dashboard') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-undo"></i>
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Export Options -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-muted">Export current view:</span>
                    <div>
                        <a href="#" class="btn btn-sm btn-outline-success me-2" onclick="exportData('csv')">
                            <i class="fas fa-file-csv me-1"></i>CSV
                        </a>
                        <a href="#" class="btn btn-sm btn-outline-success" onclick="exportData('excel')">
                            <i class="fas fa-file-excel me-1"></i>Excel
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Orders Table -->
<div class="card">
    <div class="card-body p-0">
        {% if orders %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Transaction ID</th>
                            <th>Customer</th>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Amount</th>
                            <th>Branch</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                            <tr>
                                <td>
                                    <strong class="text-primary">#{{ order.transaction_id }}</strong>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-2">
                                            <i class="fas fa-user text-white"></i>
                                        </div>
                                        <div>
                                            <div class="fw-semibold">{{ order.customer_full_name }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <div class="fw-semibold">{{ order.product_name }}</div>
                                        <small class="text-muted">ID: {{ order.product_id }}</small>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ order.quantity }}</span>
                                </td>
                                <td>
                                    <strong class="text-success">{{ "{:,.2f}".format(order.amount) }} EGP</strong>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ order.branch }}</span>
                                </td>
                                <td>
                                    <div>
                                        <div>{{ order.transaction_date.split(' ')[0] if order.transaction_date else 'N/A' }}</div>
                                        <small class="text-muted">{{ order.transaction_date.split(' ')[1] if order.transaction_date and ' ' in order.transaction_date else '' }}</small>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No orders found</h5>
                {% if filters.search or filters.branch or filters.date_from or filters.date_to or (pagination and pagination.page and pagination.page > 1) or request.args.get('page', 1, type=int) > 1 %}
                    <p class="text-muted">No results found for this page or current filters. Try:</p>
                    <ul class="list-unstyled text-muted">
                        {% if (pagination and pagination.page and pagination.page > 1) or request.args.get('page', 1, type=int) > 1 %}
                            <li>• Going back to <a href="{{ url_for('orders_dashboard', page=1, search=request.args.get('search', ''), branch=request.args.get('branch', ''), date_from=request.args.get('date_from', ''), date_to=request.args.get('date_to', ''), per_page=request.args.get('per_page', '')) }}">page 1</a></li>
                        {% endif %}
                        {% if filters.search or filters.branch or filters.date_from or filters.date_to %}
                            <li>• Clearing search terms</li>
                            <li>• Selecting "All Branches"</li>
                            <li>• Expanding date range</li>
                            <li>• Using broader search terms</li>
                        {% endif %}
                    </ul>
                    <div class="mt-2">
                        {% if (pagination and pagination.page and pagination.page > 1) or request.args.get('page', 1, type=int) > 1 %}
                            <a href="{{ url_for('orders_dashboard', page=1, search=request.args.get('search', ''), branch=request.args.get('branch', ''), date_from=request.args.get('date_from', ''), date_to=request.args.get('date_to', ''), per_page=request.args.get('per_page', '')) }}" class="btn btn-outline-primary btn-sm me-2">
                                <i class="fas fa-arrow-left me-1"></i>Go to Page 1
                            </a>
                        {% endif %}
                        <a href="{{ url_for('orders_dashboard') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-undo me-1"></i>Clear All Filters
                        </a>
                    </div>
                {% else %}
                    <p class="text-muted">No orders in the database yet.</p>
                    <div class="mt-3">
                        <p class="text-muted">To populate data, you can:</p>
                        <div class="d-flex justify-content-center gap-2 flex-wrap">
                            <a href="{{ url_for('control_panel') }}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-cogs me-1"></i>Run ETL Pipeline
                            </a>
                            <a href="{{ url_for('home') }}" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-home me-1"></i>Back to Dashboard
                            </a>
                        </div>
                    </div>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<!-- Pagination -->
{% if pagination and pagination.total_pages > 1 %}
<div class="mt-4">
    <!-- Pagination Info (Centered) -->
    <div class="text-center mb-3">
        <div class="text-muted">
            Showing {{ ((pagination.page - 1) * pagination.per_page + 1) }} to 
            {{ (pagination.page * pagination.per_page if pagination.page < pagination.total_pages else pagination.total) }} 
            of {{ pagination.total }} entries
        </div>
    </div>
    
    <!-- Pagination Controls (Centered) -->
    <div class="d-flex justify-content-center">
        <nav aria-label="Orders pagination">
            <ul class="pagination mb-0">
                {% if pagination.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('orders_dashboard', page=pagination.prev_num, search=request.args.get('search', ''), branch=request.args.get('branch', ''), date_from=request.args.get('date_from', ''), date_to=request.args.get('date_to', ''), per_page=request.args.get('per_page', '')) }}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                {% endif %}
                
                {% for page_num in range([1, pagination.page - 2]|max, [pagination.total_pages + 1, pagination.page + 3]|min) %}
                    <li class="page-item {{ 'active' if page_num == pagination.page }}">
                        <a class="page-link" href="{{ url_for('orders_dashboard', page=page_num, search=request.args.get('search', ''), branch=request.args.get('branch', ''), date_from=request.args.get('date_from', ''), date_to=request.args.get('date_to', ''), per_page=request.args.get('per_page', '')) }}">
                            {{ page_num }}
                        </a>
                    </li>
                {% endfor %}
                
                {% if pagination.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('orders_dashboard', page=pagination.next_num, search=request.args.get('search', ''), branch=request.args.get('branch', ''), date_from=request.args.get('date_from', ''), date_to=request.args.get('date_to', ''), per_page=request.args.get('per_page', '')) }}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
function exportData(format) {
    // Build export URL with current filters
    const form = document.getElementById('filterForm');
    const formData = new FormData(form);
    const params = new URLSearchParams();
    
    for (const [key, value] of formData.entries()) {
        if (value) {
            params.append(key, value);
        }
    }
    
    params.append('format', format);
    
    // Create and trigger download
    const url = '/api/orders/export?' + params.toString();
    window.open(url, '_blank');
}

// Auto-submit form on filter changes (excluding search and date inputs)
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('filterForm');
    const inputs = form.querySelectorAll('input, select');
    
    inputs.forEach(input => {
        // Only auto-submit for select dropdowns (branch, per_page), not for text/date inputs
        if (input.tagName === 'SELECT') {
            input.addEventListener('change', function() {
                form.submit();
            });
        }
    });
    
    // Submit search on Enter key
    const searchInput = document.getElementById('search');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                form.submit();
            }
        });
    }
    
    // For date inputs, only submit when user clicks away (blur) and the field has a value
    const dateInputs = form.querySelectorAll('input[type="date"]');
    dateInputs.forEach(input => {
        input.addEventListener('blur', function() {
            // Only submit if the date input has a valid value and user finished editing
            if (this.value && this.value.length === 10) {
                setTimeout(() => {
                    form.submit();
                }, 200);
            }
        });
    });
});

// Add loading state to export buttons
function showExportLoading(button) {
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Exporting...';
    button.disabled = true;
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    }, 2000);
}
</script>
{% endblock %}
